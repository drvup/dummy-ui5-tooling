/*
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./PluginBase","../utils/TableUtils","sap/ui/unified/MenuItem","sap/base/util/deepClone"],function(t,e,o,i){"use strict";function r(t,o){var i="TBL_ROW_GROUP_TITLE";var r=[o.property.label,t.getProperty(o.property.path,true)];if(o.textProperty){i="TBL_ROW_GROUP_TITLE_FULL";r.push(t.getProperty(o.textProperty.path,true))}return e.getResourceText(i,r)}var a=t.extend("sap.ui.table.plugins.V4Aggregation",{metadata:{library:"sap.ui.table",properties:{totalSummaryOnTop:{type:"string",defaultValue:"Off"},totalSummaryOnBottom:{type:"string",defaultValue:"Fixed"},groupSummary:{type:"string",defaultValue:"Bottom"},groupHeaderFormatter:{type:"function"}}}});a.prototype.isApplicable=function(e){return t.prototype.isApplicable.apply(this,arguments)&&e.getMetadata().getName()==="sap.ui.table.Table"};a.prototype.activate=function(){var e=this.getTableBinding();if(e&&!e.getModel().isA("sap.ui.model.odata.v4.ODataModel")){return}t.prototype.activate.apply(this,arguments)};a.prototype.onActivate=function(t){this.setRowCountConstraints({fixedTop:false,fixedBottom:false});e.Grouping.setGroupMode(t);e.Hook.register(t,e.Hook.Keys.Row.UpdateState,this.updateRowState,this);e.Hook.register(t,e.Hook.Keys.Row.Expand,p,this);e.Hook.register(t,e.Hook.Keys.Row.Collapse,g,this)};a.prototype.onDeactivate=function(t){this._mGroup=undefined;this._mAggregate=undefined;this._aGroupLevels=undefined;this._mColumnState=undefined;this.setRowCountConstraints();n(this);e.Grouping.clearMode(t);e.Hook.deregister(t,e.Hook.Keys.Row.UpdateState,this.updateRowState,this);e.Hook.deregister(this,e.Hook.Keys.Row.Expand,p,this);e.Hook.deregister(this,e.Hook.Keys.Row.Collapse,g,this);var o=t.getBinding();if(o){o.setAggregation()}};function n(t){var e=t.getTable();if(e){e.getColumns().forEach(function(t){t._setCellContentVisibilitySettings()})}}function s(t){var e=t.getTable();var o=t.getGroupSummary();if(!e||!t._mColumnState){return}e.getColumns().forEach(function(e){var i=t._mColumnState[e.getId()];if(i){e._setCellContentVisibilitySettings({groupHeader:{expanded:!!i.subtotals&&(o==="Top"||o==="TopAndBottom"),collapsed:!!i.subtotals&&(o==="Bottom"||o==="TopAndBottom")},summary:{group:!!i.subtotals,total:!!i.grandTotal}})}else{e._setCellContentVisibilitySettings()}})}a.prototype.onTableRowsBound=function(t){if(t.getModel().isA("sap.ui.model.odata.v4.ODataModel")){this.updateAggregation()}else{this.deactivate()}};a.prototype.updateRowState=function(t){var e=t.context.getValue("@$ui5.node.level");var o=t.context.getValue("@$ui5.node.isTotal");var i=t.context.getValue("@$ui5.node.isExpanded")===undefined;var a=e===0&&o;var n=e>0&&!i;var s=!n&&o;t.level=e;t.expandable=n;t.expanded=t.context.getValue("@$ui5.node.isExpanded")===true;if(a||s){t.type=t.Type.Summary;t.level++}else if(n){t.type=t.Type.GroupHeader}if(n){var u=this._aGroupLevels[e-1];var p=this.getGroupHeaderFormatter();var g=p?p(t.context,u.property.name):undefined;if(g===undefined){t.title=r(t.context,u)}else if(typeof g!=="string"){throw new Error("The group header title must be a string or undefined")}else{t.title=g}}};a.prototype.setPropertyInfos=function(t){this._aPropertyInfos=t};a.prototype.getPropertyInfos=function(){return this._aPropertyInfos||[]};a.prototype.findPropertyInfo=function(t){return this.getPropertyInfos().find(function(e){return e.name===t})};a.prototype.isPropertyAggregatable=function(t){return t.extension&&t.extension.defaultAggregate?true:false};a.prototype.setAggregationInfo=function(t){t=Object.assign({columnState:{}},t);if(!Array.isArray(t.visible)){this._mGroup=undefined;this._mAggregate=undefined;this._aGroupLevels=undefined}else{var e=[];var o=[];var i;this._mGroup=this.getPropertyInfos().reduce(function(t,e){if(e.key){t[e.path]={};i=u(this,e);if(i){t[e.path].additionally=i;o.concat(i)}}return t}.bind(this),{});this._mAggregate={};var r=t.visible.concat();if(t.groupLevels){t.groupLevels.forEach(function(t){if(r.indexOf(t)<0){r.push(t)}})}r.forEach(function(r){var a=this.findPropertyInfo(r);if(a&&a.groupable){this._mGroup[a.path]={};i=u(this,a);if(i){this._mGroup[a.path].additionally=i;o=o.concat(i)}}if(a&&this.isPropertyAggregatable(a)){this._mAggregate[a.path]={};if(t.grandTotal&&t.grandTotal.indexOf(r)>=0){this._mAggregate[a.path].grandTotal=true}if(t.subtotals&&t.subtotals.indexOf(r)>=0){this._mAggregate[a.path].subtotals=true}if(a.unit){var n=this.findPropertyInfo(a.unit);if(n){this._mAggregate[a.path].unit=n.path;e.push(n.path)}}if(a.extension.defaultAggregate.contextDefiningProperties){a.extension.defaultAggregate.contextDefiningProperties.forEach(function(t){var e=this.findPropertyInfo(t);if(e){this._mGroup[e.path]={};i=u(this,a);if(i){this._mGroup[e.path].additionally=i;o=o.concat(i)}}}.bind(this))}}}.bind(this));this._aGroupLevels=[];if(t.groupLevels){t.groupLevels.forEach(function(t){var e=this.findPropertyInfo(t);this._aGroupLevels.push({property:e,textProperty:this.findPropertyInfo(e.text)})}.bind(this))}Object.keys(this._mGroup).forEach(function(t){if(this._mAggregate.hasOwnProperty(t)){if(this._mAggregate[t].grandTotal||this._mAggregate[t].subtotals){delete this._mGroup[t];return}else{delete this._mAggregate[t]}}if(this._mGroup[t].additionally){this._mGroup[t].additionally=this._mGroup[t].additionally.filter(function(t){return e.indexOf(t)===-1})}if(o.indexOf(t)>-1){delete this._mGroup[t]}}.bind(this))}this._mColumnState=t.columnState;s(this);this.updateAggregation()};a.prototype.getAggregationInfo=function(){var t={aggregate:i(this._mAggregate),group:i(this._mGroup),groupLevels:this._aGroupLevels?this._aGroupLevels.map(function(t){return t.property.path}):undefined};if(t.aggregate){l(this,t);f(this,t)}return t};function u(t,e){if(e.text){var o=t.findPropertyInfo(e.text);if(o){return[o.path]}}return null}function p(t){var e=t.getRowBindingContext();if(e){e.expand()}}function g(t){var e=t.getRowBindingContext();if(e){e.collapse()}}a.prototype.setTotalSummaryOnTop=function(t){this.setProperty("totalSummaryOnTop",t,true);this.updateAggregation()};a.prototype.setTotalSummaryOnBottom=function(t){this.setProperty("totalSummaryOnBottom",t,true);this.updateAggregation()};a.prototype.setGroupSummary=function(t){this.setProperty("groupSummary",t,true);s(this);this.updateAggregation()};a.prototype.updateAggregation=function(){var t=this.getTableBinding();if(t){t.setAggregation(this.getAggregationInfo())}};function l(t,e){var o=t.getTotalSummaryOnTop();var i=t.getTotalSummaryOnBottom();var r=o==="On"||o==="Fixed";var a=i==="On"||i==="Fixed";var n=Object.keys(e.aggregate).some(function(t){return e.aggregate[t].grandTotal});if(r&&a){e.grandTotalAtBottomOnly=false}else if(a){e.grandTotalAtBottomOnly=true}else if(r){e.grandTotalAtBottomOnly=undefined}else{Object.keys(e.aggregate).forEach(function(t){delete e.aggregate[t].grandTotal})}t.setRowCountConstraints({fixedTop:o==="Fixed"&&n,fixedBottom:i==="Fixed"&&n})}function f(t,e){var o=t.getGroupSummary();if(o==="Top"){e.subtotalsAtBottomOnly=undefined}else if(o==="Bottom"){e.subtotalsAtBottomOnly=true}else if(o==="TopAndBottom"){e.subtotalsAtBottomOnly=false}else{Object.keys(e.aggregate).forEach(function(t){delete e.aggregate[t].subtotals})}}return a});