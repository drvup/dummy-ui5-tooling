/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ExtensionBase","./KeyboardDelegate","../utils/TableUtils","sap/ui/core/delegate/ItemNavigation","sap/ui/Device","sap/ui/dom/containsOrEquals","sap/ui/thirdparty/jquery"],function(e,t,i,a,o,n,s){"use strict";var l=false;function r(e){if(o.browser.msie){if(!l){s("head").append('<style type="text/css">'+"/* Avoid focus outline problems in tables */\n"+".sapUiTableStatic[data-sap-ui-table-focus]{}"+"</style>");l=true}var t=i.getCellInfo(e)||{};if(t.isOfType(i.CELLTYPE.ANY)){t.cell.attr("data-sap-ui-table-focus",Date.now())}}}var f={_forward:function(e,t){var i=e._getItemNavigation();if(i!=null&&!e._getKeyboardExtension()._isItemNavigationSuspended()&&!t.isMarked("sapUiTableSkipItemNavigation")){i["on"+t.type](t)}},onfocusin:function(e){f._forward(this,e);r(e.target)},onsapfocusleave:function(e){f._forward(this,e)},onmousedown:function(e){f._forward(this,e)},onsapnext:function(e){f._forward(this,e)},onsapnextmodifiers:function(e){f._forward(this,e)},onsapprevious:function(e){f._forward(this,e)},onsappreviousmodifiers:function(e){f._forward(this,e)},onsappageup:function(e){f._forward(this,e)},onsappagedown:function(e){f._forward(this,e)},onsaphome:function(e){f._forward(this,e)},onsaphomemodifiers:function(e){f._forward(this,e)},onsapend:function(e){f._forward(this,e)},onsapendmodifiers:function(e){f._forward(this,e)},onsapkeyup:function(e){f._forward(this,e)}};var d={onBeforeRendering:function(e){this._oStoredFocusInfo=this.getFocusInfo()},onAfterRendering:function(e){var t=e&&e.isMarked("renderRows");this._getKeyboardExtension().invalidateItemNavigation();if(this._oStoredFocusInfo&&this._oStoredFocusInfo.customId){if(t){this.applyFocusInfo(this._oStoredFocusInfo)}else{this._getKeyboardExtension().initItemNavigation()}}delete this._oStoredFocusInfo},onfocusin:function(e){var t=this._getKeyboardExtension();if(!t._bIgnoreFocusIn){t.initItemNavigation()}else{e.setMarked("sapUiTableIgnoreFocusIn")}if(e.target&&e.target.id===this.getId()+"-rsz"){e.preventDefault();e.setMarked("sapUiTableSkipItemNavigation")}}};var u={_initItemNavigation:function(e){var t=e.getTable();if(!t){return}var o=t.$();var n=t.getRows().length;var l=i.getVisibleColumnCount(t);var r=i.hasRowHeader(t);var f=i.hasRowActions(t);var d=i.hasFixedColumns(t);var c;var g=[],p,v,h,_,m;if(d){h=o.find(".sapUiTableCtrlFixed.sapUiTableCtrlRowFixed:not(.sapUiTableCHT)");_=o.find(".sapUiTableCtrlFixed.sapUiTableCtrlRowScroll:not(.sapUiTableCHT)");m=o.find(".sapUiTableCtrlFixed.sapUiTableCtrlRowFixedBottom:not(.sapUiTableCHT)")}var b=o.find(".sapUiTableCtrlScroll.sapUiTableCtrlRowFixed:not(.sapUiTableCHT)");var I=o.find(".sapUiTableCtrlScroll.sapUiTableCtrlRowScroll:not(.sapUiTableCHT)");var C=o.find(".sapUiTableCtrlScroll.sapUiTableCtrlRowFixedBottom:not(.sapUiTableCHT)");if(r){p=o.find(".sapUiTableRowSelectionCell").get();l++}if(f){v=o.find(".sapUiTableRowActionCell").get();l++}for(c=0;c<n;c++){if(r){g.push(p[c])}if(d){g=g.concat(h.find('tr[data-sap-ui-rowindex="'+c+'"]').find("td[tabindex]").get())}g=g.concat(b.find('tr[data-sap-ui-rowindex="'+c+'"]').find("td[tabindex]").get());if(d){g=g.concat(_.find('tr[data-sap-ui-rowindex="'+c+'"]').find("td[tabindex]").get())}g=g.concat(I.find('tr[data-sap-ui-rowindex="'+c+'"]').find("td[tabindex]").get());if(d){g=g.concat(m.find('tr[data-sap-ui-rowindex="'+c+'"]').find("td[tabindex]").get())}g=g.concat(C.find('tr[data-sap-ui-rowindex="'+c+'"]').find("td[tabindex]").get());if(f){g.push(v[c])}}if(t.getColumnHeaderVisible()){var T=[];var w=o.find(".sapUiTableCHT.sapUiTableCtrlFixed>tbody>tr");var y=o.find(".sapUiTableCHT.sapUiTableCtrlScroll>tbody>tr");var R=i.getHeaderRowCount(t);for(c=0;c<R;c++){if(r){T.push(t.getDomRef("selall"))}if(w.length){T=T.concat(s(w.get(c)).find(".sapUiTableHeaderCell").get())}if(y.length){T=T.concat(s(y.get(c)).find(".sapUiTableHeaderCell").get())}if(f){T.push(o.find(".sapUiTableRowActionHeaderCell").children().get(0))}}g=T.concat(g)}if(!e._itemNavigation){e._itemNavigation=new a;e._itemNavigation.setTableMode(true);e._itemNavigation.attachEvent(a.Events.AfterFocus,function(a){var o=i.getFocusedItemInfo(t);o.header=i.getHeaderRowCount(t);o.domRef=null;if(o.row>=o.header){e._oLastFocusedCellInfo=o}},t)}e._itemNavigation.setColumns(l);e._itemNavigation.setRootDomRef(o.find(".sapUiTableCnt").get(0));e._itemNavigation.setItemDomRefs(g);e._itemNavigation.setFocusedIndex(u.getInitialItemNavigationIndex(e));e._itemNavigationInvalidated=false},getInitialItemNavigationIndex:function(e){return i.hasRowHeader(e.getTable())?1:0},isItemNavigationInvalid:function(e){return!e._itemNavigation||e._itemNavigationInvalidated}};var c=e.extend("sap.ui.table.extensions.Keyboard",{_init:function(e,a,o){this._itemNavigation=null;this._itemNavigationInvalidated=false;this._itemNavigationSuspended=false;this._delegate=new t(a);this._actionMode=false;i.addDelegate(e,d,e);i.addDelegate(e,this._delegate,e);i.addDelegate(e,f,e);e._getItemNavigation=function(){return this._itemNavigation}.bind(this);return"KeyboardExtension"},_debug:function(){this._ExtensionHelper=u;this._ItemNavigationDelegate=f;this._ExtensionDelegate=d},destroy:function(){var t=this.getTable();if(t){t.removeEventDelegate(d);t.removeEventDelegate(this._delegate);t.removeEventDelegate(f)}if(this._itemNavigation){this._itemNavigation.destroy();this._itemNavigation=null}if(this._delegate){this._delegate.destroy();this._delegate=null}e.prototype.destroy.apply(this,arguments)}});c.prototype.initItemNavigation=function(){if(u.isItemNavigationInvalid(this)){u._initItemNavigation(this)}};c.prototype.invalidateItemNavigation=function(){this._itemNavigationInvalidated=true};c.prototype.setActionMode=function(e){if(!this._delegate){return}if(e===true&&!this._actionMode&&this._delegate.enterActionMode){this._actionMode=this._delegate.enterActionMode.apply(this.getTable(),Array.prototype.slice.call(arguments,1))===true}else if(e===false&&this._actionMode&&this._delegate.leaveActionMode){this._actionMode=false;this._delegate.leaveActionMode.apply(this.getTable(),Array.prototype.slice.call(arguments,1))}};c.prototype.isInActionMode=function(){return this._actionMode};c.prototype.updateNoDataAndOverlayFocus=function(){var e=this.getTable();var t=document.activeElement;if(!e||!e.getDomRef()){return}if(e.getShowOverlay()){if(n(e.getDomRef(),t)&&e.$("overlay")[0]!==t){this._oLastFocus={Ref:t,Pos:"overlay"};e.$("overlay").focus()}}else if(i.isNoDataVisible(e)&&e.$("noDataCnt")[0]!==t){if(n(e.getDomRef("tableCCnt"),t)){this._oLastFocus={Ref:t,Pos:"table content"};e.$("noDataCnt").focus()}else if(e.$("overlay")[0]===t){p(e,this)}}else if(this._oLastFocus){if(this._oLastFocus.Pos==="table content"){if(n(e.getDomRef("tableCCnt"),this._oLastFocus.Ref)){g(e,this)}else if(e.getRows()[0]&&e.getRows()[0].getDomRef("col0")){e.getRows()[0].getDomRef("col0").focus();this._oLastFocus=null}}else if(this._oLastFocus.Pos==="overlay"){if(n(e.getDomRef(),this._oLastFocus.Ref)){g(e,this)}else{p(e,this)}}}};function g(e,t){if(!s(t._oLastFocus.Ref).hasClass("sapUiTableCell")){var a=i.getParentCell(e,t._oLastFocus.Ref);if(a&&a[0]&&s(a[0]).hasClass("sapUiTableCell")){a[0].focus()}else{t._oLastFocus.Ref.focus()}}else{t._oLastFocus.Ref.focus()}t._oLastFocus=null}function p(e,t){if(e.getColumnHeaderVisible()){i.focusItem(e,u.getInitialItemNavigationIndex(t));t._oLastFocus=null}else if(i.isNoDataVisible(e)){e.$("noDataCnt").focus();t._oLastFocus=null}else if(e.getRows()[0]&&e.getRows()[0].getDomRef("col0")){e.getRows()[0].getDomRef("col0").focus();t._oLastFocus=null}}c.prototype._suspendItemNavigation=function(){this._itemNavigationSuspended=true};c.prototype._resumeItemNavigation=function(){this._itemNavigationSuspended=false};c.prototype._isItemNavigationSuspended=function(){return this._itemNavigationSuspended};c.prototype._getLastFocusedCellInfo=function(){var e=i.getHeaderRowCount(this.getTable());if(!this._oLastFocusedCellInfo||this._oLastFocusedCellInfo.header!=e){var t=i.getFocusedItemInfo(this.getTable());var a=u.getInitialItemNavigationIndex(this);return{cellInRow:a,row:e,header:e,cellCount:t.cellCount,columnCount:t.columnCount,cell:t.columnCount*e+a}}return this._oLastFocusedCellInfo};c.prototype._setSilentFocus=function(e){this._bIgnoreFocusIn=true;this._setFocus(e);this._bIgnoreFocusIn=false};c.prototype._setFocus=function(e){if(!e){return}var t=this.getTable();var a=i.getCellInfo(e);if(a.isOfType(i.CELLTYPE.ANY)&&t){var o=s(e);if(o.attr("tabindex")!="0"){var n=t._getItemNavigation();if(n&&n.aItemDomRefs){for(var l=0;l<n.aItemDomRefs.length;l++){if(n.aItemDomRefs[l]){n.aItemDomRefs[l].setAttribute("tabindex","-1")}}}o.attr("tabindex","0")}}e.focus()};c.prototype._getTableType=function(){return this._type};return c});