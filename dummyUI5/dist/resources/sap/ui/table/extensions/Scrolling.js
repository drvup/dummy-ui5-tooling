/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ExtensionBase","../utils/TableUtils","../library","sap/ui/Device","sap/ui/performance/trace/Interaction","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,r,t,o,l,i,n){"use strict";var a=t.SharedDomRef;var s=r.Hook.Keys;var c=r.createWeakMapFacade();var f=1e6;var d=2;var u={HORIZONAL:"HORIZONTAL",VERTICAL:"VERTICAL",BOTH:"BOTH"};function p(e,r){i.debug("sap.ui.table.extensions.Scrolling",e,r)}function g(e){return typeof e.isConnected==="boolean"&&e.isConnected||document.body.contains(e)}function S(e,r){var t=true;var o=false;var l=[];var i={cancel:function(){if(this.isCancelled()||!this.isRunning()){return}o=true;for(var e=0;e<l.length;e++){l[e]()}p("Process cancelled: "+r.id)},isCancelled:function(){return o},addCancelListener:function(e){l.push(e)},isRunning:function(){return t},getInfo:function(){return r},onPromiseCreated:function(e){}};var n;p("Process started: "+r.id);if(typeof e==="function"){n=new Promise(function(){e.apply(this,Array.prototype.slice.call(arguments).concat(i))})}else{n=Promise.resolve()}Object.assign(n,i);n.then(function(){if(i.isCancelled()){p("Process finished due to cancellation: "+r.id)}else{p("Process finished: "+r.id)}t=false});i.onPromiseCreated(n);return n}function v(){this.iIndex=0;this.nOffset=0;this.sOffsetType=v.OffsetType.Pixel;this.bIsInitial=true}v.OffsetType={Pixel:"Pixel",Percentage:"Percentage",PercentageOfViewport:"PercentageOfViewport"};v.prototype.getIndex=function(){return this.iIndex};v.prototype.getOffset=function(){return this.nOffset};v.prototype.getOffsetType=function(){return this.sOffsetType};v.prototype.isOffsetInPixel=function(){return this.sOffsetType===v.OffsetType.Pixel};v.prototype.isInitial=function(){return this.bIsInitial};v.prototype.setPosition=function(e,r,t){p("ScrollPosition#setPosition(index: "+e+", offset: "+r+", offsetType: "+t+")");if(!v._isPositiveNumber(e)){return}if(!v._isPositiveNumber(r)){this.nOffset=0}this.setIndex(e);this.setOffset(r,t)};v.prototype.setIndex=function(e){p("ScrollPosition#setIndex(index: "+e+")");if(!v._isPositiveNumber(e)){return}this.bIsInitial=false;this.iIndex=e};v.prototype.setOffset=function(e,r){p("ScrollPosition#setOffset(offset: "+e+", offsetType: "+r+")");if(!v._isPositiveNumber(e)){return}this.bIsInitial=false;this.sOffsetType=r in v.OffsetType?r:v.OffsetType.Pixel;if(this.isOffsetInPixel()){this.nOffset=Math.round(e)}else{this.nOffset=Math.min(e,1)}};v.prototype.scrollRows=function(e){var r=this.getIndex()+e;var t=this.getOffset();if(!this.isOffsetInPixel()||r<0){t=0}this.setPosition(Math.max(0,r),t)};v._isPositiveNumber=function(e){return typeof e==="number"&&!isNaN(e)&&e>=0};var h={UpdateFromFirstVisibleRow:{id:"UpdateFromFirstVisibleRow",rank:6},UpdateFromScrollPosition:{id:"UpdateFromScrollPosition",rank:5},RestoreScrollPosition:{id:"RestoreScrollPosition",rank:4},AdjustToTotalRowCount:{id:"AdjustToTotalRowCount",rank:3},OnRowsUpdated:{id:"OnRowsUpdated",rank:3},UpdateFromScrollbar:{id:"UpdateFromScrollbar",rank:2},UpdateFromViewport:{id:"UpdateFromViewport",rank:1},canStart:function(e,r){var t=c(e).pVerticalScrollUpdateProcess;var o=t?t.getInfo():null;if(t&&t.isRunning()&&o.rank>r.rank){p("Cannot start update process "+r.id+" - A higher-ranked update process is currently running ("+o.id+")",e);return false}return true},start:function(e,r,t){if(!h.canStart(e,r)){return}if(c(e).pVerticalScrollUpdateProcess){c(e).pVerticalScrollUpdateProcess.cancel()}c(e).pVerticalScrollUpdateProcess=new S(t,r)}};var b={onScrollbarScroll:function(e){var r=e.target.scrollLeft;var t=e.target._scrollLeft;l.notifyScrollEvent&&l.notifyScrollEvent(e);if(r!==t){var o=b.getScrollAreas(this);e.target._scrollLeft=r;for(var i=0;i<o.length;i++){var n=o[i];if(n!==e.target&&n.scrollLeft!==r){n.scrollLeft=r;n._scrollLeft=r}}c(this).iHorizontalScrollPosition=r}},restoreScrollPosition:function(e){var r=e._getScrollExtension();var t=r.getHorizontalScrollbar();if(t&&c(e).iHorizontalScrollPosition!==null){var o=b.getScrollAreas(e);for(var l=0;l<o.length;l++){var i=o[l];delete i._scrollLeft}if(t.scrollLeft!==c(e).iHorizontalScrollPosition){t.scrollLeft=c(e).iHorizontalScrollPosition}else{var a=n.Event("scroll");a.target=t;b.onScrollbarScroll.call(e,a)}}},onScrollbarMouseDown:function(e){this._getKeyboardExtension().setActionMode(false)},addEventListeners:function(e){var r=e._getScrollExtension();var t=r.getHorizontalScrollbar();var o=b.getScrollAreas(e);if(!r._onHorizontalScrollEventHandler){r._onHorizontalScrollEventHandler=b.onScrollbarScroll.bind(e)}for(var l=0;l<o.length;l++){o[l].addEventListener("scroll",r._onHorizontalScrollEventHandler)}if(t){if(!r._onHorizontalScrollbarMouseDownEventHandler){r._onHorizontalScrollbarMouseDownEventHandler=b.onScrollbarMouseDown.bind(e)}t.addEventListener("mousedown",r._onHorizontalScrollbarMouseDownEventHandler)}},removeEventListeners:function(e){var r=e._getScrollExtension();var t=r.getHorizontalScrollbar();var o=b.getScrollAreas(e);if(r._onHorizontalScrollEventHandler){for(var l=0;l<o.length;l++){o[l].removeEventListener("scroll",r._onHorizontalScrollEventHandler);delete o[l]._scrollLeft}delete r._onHorizontalScrollEventHandler}if(t&&r._onHorizontalScrollbarMouseDownEventHandler){t.removeEventListener("mousedown",r._onHorizontalScrollbarMouseDownEventHandler);delete r._onHorizontalScrollbarMouseDownEventHandler}},getScrollAreas:function(e){var r=e.getDomRef();var t;if(r){t=Array.prototype.slice.call(e.getDomRef().querySelectorAll(".sapUiTableCtrlScr"))}var o=[e._getScrollExtension().getHorizontalScrollbar()].concat(t);return o.filter(function(e){return e!=null})}};var V={performUpdateFromFirstVisibleRow:function(e,t){p("VerticalScrollingHelper.performUpdateFromFirstVisibleRow",e);h.start(e,h.UpdateFromFirstVisibleRow,function(o,l,i){r.Hook.call(e,s.Signal,"StartTableUpdate");i.onPromiseCreated=function(t){t.finally(function(){r.Hook.call(e,s.Signal,"EndTableUpdate")})};if(t===true){var n=function(){p("VerticalScrollingHelper.performUpdateFromFirstVisibleRow (async: rows update)",e);V._performUpdateFromFirstVisibleRow(e,i).then(o);return false};V.addOnRowsUpdatedPreprocessor(e,n);i.addCancelListener(function(){var r=V.removeOnRowsUpdatedPreprocessor(e,n);if(r){o()}})}else{V._performUpdateFromFirstVisibleRow(e,i).then(o)}})},_performUpdateFromFirstVisibleRow:function(e,r){return V.adjustScrollPositionToFirstVisibleRow(e,r).then(function(){return V.fixTemporaryFirstVisibleRow(e,null,r)}).then(function(){return V.fixScrollPosition(e,r)}).then(function(){return Promise.all([V.scrollViewport(e,r),V.scrollScrollbar(e,r)])})},performUpdateFromScrollPosition:function(e){p("VerticalScrollingHelper.performUpdateFromScrollPosition",e);h.start(e,h.UpdateFromScrollPosition,function(t,o,l){r.Hook.call(e,s.Signal,"StartTableUpdate");l.onPromiseCreated=function(t){t.finally(function(){r.Hook.call(e,s.Signal,"EndTableUpdate")})};V.adjustFirstVisibleRowToScrollPosition(e,null,l).then(function(){if(l.isCancelled()){return}var t=c(e).oVerticalScrollPosition;p("VerticalScrollingHelper.performUpdateFromScrollPosition (async: firstVisibleRow update)",e);if(t.getIndex()>e.getFirstVisibleRow()){t.setIndex(e.getFirstVisibleRow());if(r.isVariableRowHeightEnabled(e)){t.setOffset(1,v.OffsetType.Percentage)}else{t.setOffset(0)}}}).then(function(){return V.fixScrollPosition(e,l)}).then(function(){return Promise.all([V.scrollViewport(e,l),V.scrollScrollbar(e,l)])}).then(t)})},performUpdateFromScrollbar:function(e){p("VerticalScrollingHelper.performUpdateFromScrollbar",e);clearTimeout(c(e).mTimeouts.largeDataScrolling);delete c(e).mTimeouts.largeDataScrolling;h.start(e,h.UpdateFromScrollbar,function(t,o,l){r.Hook.call(e,s.Signal,"StartTableUpdate");l.onPromiseCreated=function(t){t.finally(function(){r.Hook.call(e,s.Signal,"EndTableUpdate")})};e._getKeyboardExtension().setActionMode(false);if(e._bLargeDataScrolling){c(e).mTimeouts.largeDataScrolling=setTimeout(function(){delete c(e).mTimeouts.largeDataScrolling;if(e._getScrollExtension().getVerticalScrollbar()!=null){p("VerticalScrollingHelper.performUpdateFromScrollbar (async: large data scrolling)",e);V._performUpdateFromScrollbar(e,l).then(t)}else{p("VerticalScrollingHelper.performUpdateFromScrollbar (async: large data scrolling): No scrollbar",e)}},300);l.addCancelListener(function(){if(c(e).mTimeouts.largeDataScrolling!=null){clearTimeout(c(e).mTimeouts.largeDataScrolling);delete c(e).mTimeouts.largeDataScrolling;t()}})}else{V._performUpdateFromScrollbar(e,l).then(t)}})},_performUpdateFromScrollbar:function(e,r){return V.adjustScrollPositionToScrollbar(e,r).then(function(){return V.adjustFirstVisibleRowToScrollPosition(e,null,r)}).then(function(){return V.fixScrollPosition(e,r)}).then(function(){return V.scrollViewport(e,r)})},performUpdateFromViewport:function(e){p("VerticalScrollingHelper.performUpdateFromViewport",e);h.start(e,h.UpdateFromViewport,function(t,o,l){r.Hook.call(e,s.Signal,"StartTableUpdate");l.onPromiseCreated=function(t){t.finally(function(){r.Hook.call(e,s.Signal,"EndTableUpdate")})};V.adjustScrollPositionToViewport(e,l).then(function(){return V.adjustFirstVisibleRowToScrollPosition(e,true,l)}).then(function(){return V.scrollScrollbar(e,l)}).then(t)})},onScrollbarScroll:function(e){l.notifyScrollEvent&&l.notifyScrollEvent(e);var r=e.target.scrollTop;var t=e.target._scrollTop;var o=r!==t;delete e.target._scrollTop;if(r===0&&!g(e.target)){p("VerticalScrollingHelper.onScrollbarScroll: Scrollbar is not connected with the DOM",this)}else if(o){p("VerticalScrollingHelper.onScrollbarScroll: Scroll position changed to "+r+" by interaction",this);V.performUpdateFromScrollbar(this)}else{p("VerticalScrollingHelper.onScrollbarScroll: Scroll position changed to "+r+" by API",this)}},onViewportScroll:function(e){if(!h.canStart(this,h.UpdateFromViewport)){return}var r=e.target.scrollTop;var t=e.target._scrollTop;delete e.target._scrollTop;if(r!==t){p("VerticalScrollingHelper.onViewportScroll: Scroll position changed to "+r+" by interaction",this);V.performUpdateFromViewport(this)}else{p("VerticalScrollingHelper.onViewportScroll: Scroll position changed to "+r+" by API",this)}},adjustFirstVisibleRowToScrollPosition:function(e,r,t){if(t&&t.isCancelled()){return Promise.resolve()}r=r===true;var o=c(e).oVerticalScrollPosition;var l=o.getOffsetType()===v.OffsetType.PercentageOfViewport;var i=o.getIndex();var n=e.getFirstVisibleRow();var a=V.isIndexInBuffer(e,i);var s=a||l;p("VerticalScrollingHelper.adjustFirstVisibleRowToScrollPosition:"+' Set "firstVisibleRow" from '+n+" to "+i,e);var f=e._setFirstVisibleRowIndex(i,{onScroll:true,suppressEvent:s,suppressRendering:r});if(!f){if(s){return V.fixTemporaryFirstVisibleRow(e,true,t)}return Promise.resolve()}return new Promise(function(r){var o=function(o){p("VerticalScrollingHelper.adjustFirstVisibleRowToScrollPosition (async: rows updated):"+" Reason "+o.getParameters().reason,this);if(s){V.fixTemporaryFirstVisibleRow(e,true,t).then(r)}else{r()}return false};V.addOnRowsUpdatedPreprocessor(e,o);if(t){t.addCancelListener(function(){var t=V.removeOnRowsUpdatedPreprocessor(e,o);if(t){r()}})}})},fixTemporaryFirstVisibleRow:function(e,r,t){if(t&&t.isCancelled()){return Promise.resolve()}r=r===true;var o=c(e).oVerticalScrollPosition;var l=o.getOffsetType()===v.OffsetType.PercentageOfViewport;var i=o.getIndex();var n=V.isIndexInBuffer(e,i);var a=n||l;if(!a){p("VerticalScrollingHelper.fixTemporaryFirstVisibleRow: Aborted - The index is already final",e);return Promise.resolve()}var s=i;var f=V.getScrollRangeOfViewport(e);var d=e._getMaxFirstRenderedRowIndex();var u=e._aRowHeights;var g;p("VerticalScrollingHelper.fixTemporaryFirstVisibleRow",e);if(l){var S=f*o.getOffset();if(n){s=d}for(g=0;g<u.length;g++){var h=S-u[g];if(h>=0){S=h;s++}else{break}}}else if(n){var b=Math.max(0,Math.min(u.length-1,i-d));var m=0;for(g=0;g<b;g++){m+=u[g];if(m>f){s=d+g;break}}}if(i!==s||r){p('VerticalScrollingHelper.fixTemporaryFirstVisibleRow: Set "firstVisibleRow" to '+s,e);e._setFirstVisibleRowIndex(s,{onScroll:true,forceEvent:r,suppressRendering:true})}return Promise.resolve()},adjustScrollPositionToFirstVisibleRow:function(e,r){if(r&&r.isCancelled()){return Promise.resolve()}p("VerticalScrollingHelper.adjustScrollPositionToFirstVisibleRow",e);c(e).oVerticalScrollPosition.setPosition(e.getFirstVisibleRow());return Promise.resolve()},adjustScrollPositionToScrollbar:function(e,t){if(t&&t.isCancelled()){return Promise.resolve()}var o=c(e).oVerticalScrollPosition;var l=V.getScrollPositionOfScrollbar(e);var i=V.getScrollRange(e);var n=V.getScrollRangeRowFraction(e);var a=0;var s=0;var f=v.OffsetType.Percentage;var d;p("VerticalScrollingHelper.adjustScrollPositionToScrollbar",e);if(r.isVariableRowHeightEnabled(e)){if(V.isScrollPositionOfScrollbarInBuffer(e)){var u=V.getScrollRangeBuffer(e);var g=i-u;var S=l-g;var h=S/u;a=e._getMaxFirstRenderedRowIndex();if(V.isIndexInBuffer(e,o.getIndex())){var b=V.getScrollRangeOfViewport(e);var m=b*h;var T=e._aRowHeights;for(var w=0;w<T.length;w++){var R=m-T[w];if(R>=0){m=R;a++}else{s=Math.round(m);f=v.OffsetType.Pixel;break}}}else{s=h;f=v.OffsetType.PercentageOfViewport}}else{d=l/n;a=Math.floor(d);s=d-a}}else{var P=i-l;var H=P<1;if(H){a=e._getMaxFirstVisibleRowIndex();s=0;f=v.OffsetType.Pixel}else{d=l/n;a=Math.floor(d);s=d-a}}o.setPosition(a,s,f);return Promise.resolve()},adjustScrollPositionToViewport:function(e,r){if(r&&r.isCancelled()){return Promise.resolve()}var t=c(e).oVerticalScrollPosition;var o=e._aRowHeights;var l=e._getFirstRenderedRowIndex();var i=0;var n=V.getScrollPositionOfViewport(e);p("VerticalScrollingHelper.adjustScrollPositionToViewport",e);for(var a=0;a<o.length;a++){var s=n-o[a];if(s>=0){n=s;l++}else{i=Math.round(n);break}}t.setPosition(l,i);return Promise.resolve()},fixScrollPosition:function(e,t){if(t&&t.isCancelled()){return Promise.resolve()}var o=c(e).oVerticalScrollPosition;var l=e.getDomRef("tableCCnt");var i=V.getScrollRangeOfViewport(e);var n=e._aRowHeights;if(!l||!e.getBinding()){p("VerticalScrollingHelper.fixScrollPosition: Aborted - Viewport or binding not available",e);return Promise.resolve()}p("VerticalScrollingHelper.fixScrollPosition",e);var a=o.getIndex();var s=o.getOffset();var f=0;var d;var u=e._getFirstRenderedRowIndex();switch(o.getOffsetType()){case v.OffsetType.Pixel:case v.OffsetType.Percentage:var g=o.getIndex();var S=0;var h=o.getOffsetType();if(V.isIndexInBuffer(e,g)){var b=0;f=Math.max(0,Math.min(n.length-1,g-u));for(d=0;d<f;d++){b+=n[d];if(b>i){a=u+d;s=i-S;h=v.OffsetType.Pixel;f=d;break}else{S=b}}}if(h===v.OffsetType.Pixel){s=Math.min(s,n[f])}else{s=n[f]*s}S+=s;if(S>i&&r.isVariableRowHeightEnabled(e)){s-=S-i}break;case v.OffsetType.PercentageOfViewport:var m=i*o.getOffset();for(d=0;d<n.length;d++){var T=m-n[d];if(T>=0){m=T;f++}else{a=u+f;s=Math.round(m);break}}break;default:}o.setPosition(a,s);return Promise.resolve()},scrollViewport:function(e,t){if(t&&t.isCancelled()){return Promise.resolve()}if(!r.isVariableRowHeightEnabled(e)){p("VerticalScrollingHelper.scrollViewport: Aborted - Variable row height not enabled",e);return Promise.resolve()}var o=c(e).oVerticalScrollPosition;var l=e.getDomRef("tableCCnt");var i=V.getScrollRangeOfViewport(e);var n=e._aRowHeights;var a=0;if(i===0){p("VerticalScrollingHelper.scrollViewport: Aborted - No overflow in viewport",e);l.scrollTop=a;l._scrollTop=l.scrollTop;return Promise.resolve()}p("VerticalScrollingHelper.scrollViewport",e);switch(o.getOffsetType()){case v.OffsetType.Pixel:var s=o.getIndex();var f=Math.max(0,Math.min(n.length-1,s-e._getFirstRenderedRowIndex()));for(var d=0;d<f;d++){a+=n[d]}a+=o.getOffset();break;default:p("VerticalScrollingHelper.scrollViewport: The viewport can only be scrolled if the offset is in pixel",e);return Promise.resolve()}p("VerticalScrollingHelper.scrollViewport: Scroll from "+l.scrollTop+" to "+a,e);l.scrollTop=a;l._scrollTop=l.scrollTop;return Promise.resolve()},scrollScrollbar:function(e,r){if(r&&r.isCancelled()){return Promise.resolve()}var t=c(e).oVerticalScrollPosition;var o=t.getIndex();var l=V.getScrollRangeBuffer(e);var i=V.getScrollRange(e);var n=i-l;var a=0;var s=0;var f=V.getScrollRangeOfViewport(e);var d=e._aRowHeights;var u;p("VerticalScrollingHelper.scrollScrollbar",e);if(i===0||d.length===0){p("VerticalScrollingHelper.scrollScrollbar: No scrollable content",e);return Promise.resolve()}switch(t.getOffsetType()){case v.OffsetType.Pixel:if(V.isIndexInBuffer(e,o)){var g=0;u=Math.max(0,Math.min(d.length-1,o-e._getMaxFirstRenderedRowIndex()));for(var S=0;S<u;S++){g+=d[S]}g+=Math.min(d[u],t.getOffset());var h=Math.min(g/f,1);var b=l*h;a=n+b}else{var m=V.getScrollRangeRowFraction(e);a=o*m;u=Math.max(0,Math.min(d.length-1,o-e._getFirstRenderedRowIndex()));a+=m*Math.min(t.getOffset()/d[u],1)}break;default:p("VerticalScrollingHelper.scrollViewport: The scrollbar can only be scrolled if the offset is in pixel",e);return Promise.resolve()}if(a>0&&a<.5){s=1}else if(a>=i-.5&&a<i){s=i-1}else{s=Math.round(a)}var T=e._getScrollExtension().getVerticalScrollbar();if(T){p("VerticalScrollingHelper.scrollScrollbar: Scroll from "+T.scrollTop+" to "+s,e);T.scrollTop=s;T._scrollTop=T.scrollTop}else{p("VerticalScrollingHelper.scrollScrollbar: Not scrolled - No scrollbar available",e)}return Promise.resolve()},getScrollRange:function(e){var r=e._getScrollExtension();var t=r.getVerticalScrollHeight()-r.getVerticalScrollbarHeight();return Math.max(0,t)},getScrollRangeBuffer:function(e){if(!r.isVariableRowHeightEnabled(e)){return 0}return d*e._getBaseRowHeight()},getScrollPositionOfScrollbar:function(e){var r=e._getScrollExtension();if(r.isVerticalScrollbarVisible()){return r.getVerticalScrollbar().scrollTop}else{return 0}},getScrollPositionOfViewport:function(e){var r=e?e.getDomRef("tableCCnt"):null;return r?r.scrollTop:0},getScrollRangeRowFraction:function(e){var t=e._getScrollExtension();var o=e._getTotalRowCount()-e._getRowCounts()._fullsize;var l;if(r.isVariableRowHeightEnabled(e)){l=V.getScrollRange(e)-V.getScrollRangeBuffer(e);var i=t.getVerticalScrollHeight()===f;if(!i){l+=e._getBaseRowHeight()}}else{l=V.getScrollRange(e)}return l/Math.max(1,o)},isScrollPositionOfScrollbarInBuffer:function(e){if(!r.isVariableRowHeightEnabled(e)){return false}var t=V.getScrollRange(e);var o=V.getScrollPositionOfScrollbar(e);var l=V.getScrollRangeBuffer(e);return t-o<=l},isIndexInBuffer:function(e,t){if(!r.isVariableRowHeightEnabled(e)){return false}return t>=e._getMaxFirstRenderedRowIndex()},getScrollRangeOfViewport:function(e){if(!e||!e._aRowHeights){return 0}var r=e._aRowHeights;var t=e._getBaseRowHeight()*e._getRowCounts()._fullsize;if(e._getRowCounts()._fullsize>=e._getTotalRowCount()){r=r.slice(0,e._getTotalRowCount())}var o=r.reduce(function(e,r){return e+r},0)-t;if(o>0){o=Math.ceil(o)}return Math.max(0,o)},addOnRowsUpdatedPreprocessor:function(e,r){c(e).aOnRowsUpdatedPreprocessors.push(r)},removeOnRowsUpdatedPreprocessor:function(e,r){if(!r){c(e).aOnRowsUpdatedPreprocessors=[];return false}var t=c(e).aOnRowsUpdatedPreprocessors.indexOf(r);if(t>-1){c(e).aOnRowsUpdatedPreprocessors.splice(t,1);return true}return false},onRowsUpdated:function(e){p("VerticalScrollingHelper.onRowsUpdated: Reason "+e.getParameters().reason,this);this._getScrollExtension().updateVerticalScrollbarVisibility();if(c(this).aOnRowsUpdatedPreprocessors.length>0){p("VerticalScrollingHelper.onRowsUpdated (preprocessors)",this);var t=c(this).aOnRowsUpdatedPreprocessors.reduce(function(r,t){var o=t.call(this,e);return!(r&&!o)},true);V.removeOnRowsUpdatedPreprocessor(this);if(!t){p("VerticalScrollingHelper.onRowsUpdated (preprocessors): Default prevented",this);return}}if(!r.isVariableRowHeightEnabled(this)){p("VerticalScrollingHelper.onRowsUpdated: Aborted - Variable row heights not enabled",this);return}var o=this;h.start(this,h.OnRowsUpdated,function(e,t,l){r.Hook.call(o,s.Signal,"StartTableUpdate");l.onPromiseCreated=function(e){e.finally(function(){r.Hook.call(o,s.Signal,"EndTableUpdate")})};V.fixScrollPosition(o,l).then(function(){return Promise.all([V.adjustFirstVisibleRowToScrollPosition(o,true,l),V.scrollViewport(o,l),V.scrollScrollbar(o,l)])}).then(e)})},restoreScrollPosition:function(e,t){p("VerticalScrollingHelper.restoreScrollPosition",e);h.start(e,h.RestoreScrollPosition,function(o,l,i){r.Hook.call(e,s.Signal,"StartTableUpdate");i.onPromiseCreated=function(t){t.then(function(){if(!i.isCancelled()){V._restoreScrollPosition(e)}}).finally(function(){r.Hook.call(e,s.Signal,"EndTableUpdate")})};if(t!==true){o();return}var n=function(){p("VerticalScrollingHelper.restoreScrollPosition (async: rows updated)",e);o();return false};V.addOnRowsUpdatedPreprocessor(e,n);i.addCancelListener(function(){var r=V.removeOnRowsUpdatedPreprocessor(e,n);if(r){o()}})})},_restoreScrollPosition:function(e){var r=c(e).oVerticalScrollPosition;var t=r.isInitial();p("VerticalScrollingHelper.restoreScrollPosition: "+"Scroll position is"+(t?" ":" not ")+"initial",e);if(t){V.performUpdateFromFirstVisibleRow(e)}else{V.performUpdateFromScrollPosition(e)}},adjustToTotalRowCount:function(e){var t=e._getScrollExtension();p("VerticalScrollingHelper.adjustToTotalRowCount",e);t.updateVerticalScrollbarVisibility();t.updateVerticalScrollHeight();h.start(e,h.AdjustToTotalRowCount,function(t,o,l){r.Hook.call(e,s.Signal,"StartTableUpdate");l.onPromiseCreated=function(t){t.then(function(){if(l.isCancelled()||c(e).oVerticalScrollPosition.isInitial()){return}V.performUpdateFromScrollPosition(e)}).finally(function(){r.Hook.call(e,s.Signal,"EndTableUpdate")})};if(c(e).oVerticalScrollPosition.isInitial()){t()}else{var i=function(){p("VerticalScrollingHelper.adjustToTotalRowCount (async: rows updated)",e);t();return false};V.addOnRowsUpdatedPreprocessor(e,i);l.addCancelListener(function(){var r=V.removeOnRowsUpdatedPreprocessor(e,i);if(r){t()}})}})},addEventListeners:function(e){var r=e._getScrollExtension();var t=V.getScrollAreas(e);var o=e.getDomRef("tableCCnt");if(!r._onVerticalScrollEventHandler){r._onVerticalScrollEventHandler=V.onScrollbarScroll.bind(e)}for(var l=0;l<t.length;l++){t[l].addEventListener("scroll",r._onVerticalScrollEventHandler)}if(o){if(!r._onViewportScrollEventHandler){r._onViewportScrollEventHandler=V.onViewportScroll.bind(e)}o.addEventListener("scroll",r._onViewportScrollEventHandler)}e.attachRowsUpdated(V.onRowsUpdated)},removeEventListeners:function(e){var r=e._getScrollExtension();var t=V.getScrollAreas(e);var o=e.getDomRef("tableCCnt");if(r._onVerticalScrollEventHandler){for(var l=0;l<t.length;l++){t[l].removeEventListener("scroll",r._onVerticalScrollEventHandler)}delete r._onVerticalScrollEventHandler}if(o&&r._onViewportScrollEventHandler){o.removeEventListener("scroll",r._onViewportScrollEventHandler);delete r._onViewportScrollEventHandler}e.detachRowsUpdated(V.onRowsUpdated)},getScrollAreas:function(e){var r=[e._getScrollExtension().getVerticalScrollbar()];return r.filter(function(e){return e!=null})}};var m={onMouseWheelScrolling:function(e,t){var o=this._getScrollExtension();var l=Math.abs(t.deltaY)>Math.abs(t.deltaX);var i=l?t.deltaY:t.deltaX;var n=l&&t.shiftKey||!l;var a=i>0;var s=false;if(i===0){return}if(n&&(e.scrollDirection===u.HORIZONAL||e.scrollDirection===u.BOTH)){var f=o.getHorizontalScrollbar();if(t.deltaMode!==window.WheelEvent.DOM_DELTA_PIXEL){var d=r.Column.getMinColumnWidth();i=a?d:-d}if(a){s=f.scrollLeft===f.scrollWidth-f.offsetWidth}else{s=f.scrollLeft===0}if(o.isHorizontalScrollbarVisible()&&!s){t.preventDefault();t.stopPropagation();this._getKeyboardExtension().setActionMode(false);f.scrollLeft=f.scrollLeft+i}}else if(!n&&(e.scrollDirection===u.VERTICAL||e.scrollDirection===u.BOTH)){var p=o.getVerticalScrollbar();var g=c(this).oVerticalScrollPosition;if(a){s=p.scrollTop===p.scrollHeight-p.offsetHeight}else{s=p.scrollTop===0}if(!o.isVerticalScrollbarVisible()||s){return}t.preventDefault();t.stopPropagation();if(t.deltaMode===window.WheelEvent.DOM_DELTA_PIXEL){var S=i/this._getDefaultRowHeight();if(S>=0){g.scrollRows(Math.max(1,Math.floor(S)))}else{g.scrollRows(Math.min(-1,Math.ceil(S)))}}else if(t.deltaMode===window.WheelEvent.DOM_DELTA_LINE){g.scrollRows(i)}else if(t.deltaMode===window.WheelEvent.DOM_DELTA_PAGE){g.scrollRows(i*this._getRowCounts()._scrollSize)}this._getKeyboardExtension().setActionMode(false);V.performUpdateFromScrollPosition(this)}},onTouchStart:function(e,r){if(r.type==="touchstart"||r.pointerType==="touch"){var t=this._getScrollExtension();var o=t.getHorizontalScrollbar();var l=t.getVerticalScrollbar();var i=r.touches?r.touches[0]:r;c(this).mTouchSessionData={initialPageX:i.pageX,initialPageY:i.pageY,initialScrollTop:l?l.scrollTop:0,initialScrollLeft:o?o.scrollLeft:0,initialScrolledToEnd:null,touchMoveDirection:null}}},onTouchMoveScrolling:function(e,r){if(r.type!=="touchmove"&&r.pointerType!=="touch"){return}var t=this._getScrollExtension();var o=c(this).mTouchSessionData;if(!o){return}var l=r.touches?r.touches[0]:r;var i=l.pageX-o.initialPageX;var n=l.pageY-o.initialPageY;var a=false;if(!o.touchMoveDirection){if(i===0&&n===0){return}o.touchMoveDirection=Math.abs(i)>Math.abs(n)?"horizontal":"vertical"}switch(o.touchMoveDirection){case"horizontal":var s=t.getHorizontalScrollbar();if(s&&(e.scrollDirection===u.HORIZONAL||e.scrollDirection===u.BOTH)){this._getKeyboardExtension().setActionMode(false);if(o.initialScrolledToEnd==null){if(i<0){o.initialScrolledToEnd=s.scrollLeft===s.scrollWidth-s.offsetWidth}else{o.initialScrolledToEnd=s.scrollLeft===0}}if(!o.initialScrolledToEnd){s.scrollLeft=o.initialScrollLeft-i;a=true}}break;case"vertical":var f=t.getVerticalScrollbar();if(f&&(e.scrollDirection===u.VERTICAL||e.scrollDirection===u.BOTH)){this._getKeyboardExtension().setActionMode(false);if(o.initialScrolledToEnd==null){if(n<0){o.initialScrolledToEnd=f.scrollTop===f.scrollHeight-f.offsetHeight}else{o.initialScrolledToEnd=f.scrollTop===0}}if(!o.initialScrolledToEnd){f.scrollTop=o.initialScrollTop-n;a=true}}break;default:}if(a){r.preventDefault()}},addEventListeners:function(e){var r=e._getScrollExtension();var t=m.getEventListenerTargets(e);r._mMouseWheelEventListener=this.addMouseWheelEventListener(t,e,{scrollDirection:u.BOTH});r._mTouchEventListener=this.addTouchEventListener(t,e,{scrollDirection:u.BOTH})},addMouseWheelEventListener:function(e,r,t){var o=m.onMouseWheelScrolling.bind(r,t);for(var l=0;l<e.length;l++){e[l].addEventListener("wheel",o)}return{wheel:o}},addTouchEventListener:function(e,r,t){var l=m.onTouchStart.bind(r,t);var i=m.onTouchMoveScrolling.bind(r,t);var n={};for(var a=0;a<e.length;a++){if(o.support.pointer&&o.system.desktop){e[a].addEventListener("pointerdown",l);e[a].addEventListener("pointermove",i,o.browser.chrome?{passive:true}:false)}else if(o.support.touch){e[a].addEventListener("touchstart",l);e[a].addEventListener("touchmove",i)}}if(o.support.pointer&&o.system.desktop){n={pointerdown:l,pointermove:i}}else if(o.support.touch){n={touchstart:l,touchmove:i}}return n},removeEventListeners:function(e){var r=e._getScrollExtension();var t=m.getEventListenerTargets(e);function o(e,r){for(var t in r){var o=r[t];if(o){e.removeEventListener(t,o)}}}for(var l=0;l<t.length;l++){o(t[l],r._mMouseWheelEventListener);o(t[l],r._mTouchEventListener)}delete r._mMouseWheelEventListener;delete r._mTouchEventListener},getEventListenerTargets:function(e){var r=[e.getDomRef("tableCCnt")];return r.filter(function(e){return e!=null})}};var T={onBeforeRendering:function(e){this._getScrollExtension()._clearCache()},onAfterRendering:function(e){var r=this._getScrollExtension();var t=e!=null&&e.isMarked("renderRows");if(t){r.updateVerticalScrollbarHeight();r.updateVerticalScrollHeight()}else{V.restoreScrollPosition(this,this.getBinding()!=null)}b.restoreScrollPosition(this)},onfocusin:function(e){var t;var l=r.getCellInfo(e.target);var i=this._getScrollExtension().getHorizontalScrollbar();if(l.isOfType(r.CELLTYPE.DATACELL)){t=this.getDomRef("sapUiTableCtrlScr")}else if(l.isOfType(r.CELLTYPE.COLUMNHEADER)){t=this.getDomRef("sapUiTableColHdrScr")}if(t&&i&&l.columnIndex>=this.getComputedFixedColumnCount()){var a=n(i);var c=l.cell[0];var f=this._bRtlMode?a.scrollLeftRTL():i.scrollLeft;var d=t.clientWidth;var u=c.offsetLeft;var p=u+c.offsetWidth;var g=u-f;var S=p-d-f;var v;if(g<0&&S<0){v=f+g}else if(S>0&&g>0){v=f+S}if(v!=null){if(this._bRtlMode){a.scrollLeftRTL(v)}else{i.scrollLeft=v}}}var h=r.getParentCell(this,e.target);if(h){var b=this;var V=function(){var e=h.find(".sapUiTableCellInner");if(e.length>0){if(b._bRtlMode){e.scrollLeftRTL(e[0].scrollWidth-e[0].clientWidth)}else{e[0].scrollLeft=0}e[0].scrollTop=0}r.Hook.call(b,s.Signal,"EndFocusHandling");r.Hook.call(b,s.Signal,"EndTableUpdate")};r.Hook.call(this,s.Signal,"StartTableUpdate");r.Hook.call(this,s.Signal,"StartFocusHandling");Promise.resolve().then(function(){if(o.browser.safari){window.setTimeout(V,0)}else{V()}})}}};var w=e.extend("sap.ui.table.extensions.Scrolling",{_init:function(e,t,o){var l=c(e);l.oHorizontalScrollbar=null;l.iHorizontalScrollPosition=null;l.oVerticalScrollbar=null;l.oVerticalScrollPosition=new v(e);l.pVerticalScrollUpdateProcess=null;l.oExternalVerticalScrollbar=null;l.bIsVerticalScrollbarExternal=false;l.mTimeouts={};l.mAnimationFrames={};l.mTouchSessionData=null;l.aOnRowsUpdatedPreprocessors=[];r.addDelegate(e,T,e);return"ScrollExtension"},_attachEvents:function(){var e=this.getTable();b.addEventListeners(e);V.addEventListeners(e);m.addEventListeners(e)},_detachEvents:function(){var e=this.getTable();b.removeEventListeners(e);V.removeEventListeners(e);m.removeEventListeners(e)},destroy:function(){var t=this.getTable();this._clearCache();if(t){r.removeDelegate(t,T);if(c(t).pVerticalScrollUpdateProcess){c(t).pVerticalScrollUpdateProcess.cancel();c(t).pVerticalScrollUpdateProcess=null}}e.prototype.destroy.apply(this,arguments)}});w.prototype.scrollVertically=function(e,r){var t=this.getTable();if(!t){return}var o=t._getRowCounts();var l=t._getFirstRenderedRowIndex();var i=r===true?o.scrollable:1;if(e===true){c(t).oVerticalScrollPosition.setPosition(l+i,1,v.OffsetType.PercentageOfViewport)}else{c(t).oVerticalScrollPosition.setPosition(Math.max(0,l-i))}V.performUpdateFromScrollPosition(t)};w.prototype.scrollVerticallyMax=function(e){var r=this.getTable();if(!r){return}if(e===true){c(r).oVerticalScrollPosition.setPosition(r._getMaxFirstRenderedRowIndex(),1,v.OffsetType.PercentageOfViewport)}else{c(r).oVerticalScrollPosition.setPosition(0)}V.performUpdateFromScrollPosition(r)};w.prototype.getHorizontalScrollbar=function(){var e=this.getTable();if(!e){return null}if(!e._bInvalid&&!c(e).oHorizontalScrollbar){c(e).oHorizontalScrollbar=e.getDomRef(a.HorizontalScrollBar)}return c(e).oHorizontalScrollbar};w.prototype.getVerticalScrollbar=function(e){var r=this.getTable();var t=this.isVerticalScrollbarExternal();if(!r){return null}if(!r._bInvalid&&!c(r).oVerticalScrollbar){c(r).oVerticalScrollbar=r.getDomRef(a.VerticalScrollBar);if(!c(r).oVerticalScrollbar&&t){c(r).oVerticalScrollbar=c(r).oExternalVerticalScrollbar}}var o=c(r).oVerticalScrollbar;if(o&&!t&&!e&&!g(o)){return null}return o};w.prototype.isHorizontalScrollbarVisible=function(){var e=this.getHorizontalScrollbar();return e!=null&&!e.classList.contains("sapUiTableHidden")};w.prototype.isVerticalScrollbarVisible=function(){var e=this.getVerticalScrollbar();return e!=null&&!e.classList.contains("sapUiTableHidden")};w.prototype.isVerticalScrollbarExternal=function(){var e=this.getTable();return e?c(e).bIsVerticalScrollbarExternal:false};w.prototype.markVerticalScrollbarAsExternal=function(e){var r=this.getTable();if(r&&e){c(r).bIsVerticalScrollbarExternal=true;c(r).oExternalVerticalScrollbar=e}};w.prototype.updateHorizontalScrollbar=function(e){var r=this.getTable();var t=this.getHorizontalScrollbar();if(!r||!t||!e){return}var l=r.$();var i=e.tableCtrlScrollWidth;if(o.browser.safari){i=Math.max(i,r._getColumnsWidth(r.getComputedFixedColumnCount()))}var n=i>e.tableCtrlScrWidth;if(n){if(!this.isHorizontalScrollbarVisible()){l.addClass("sapUiTableHScr");t.classList.remove("sapUiTableHidden");if(o.browser.safari){var a=l.find(".sapUiTableCtrlScroll, .sapUiTableColHdrScr > .sapUiTableColHdr");a.outerWidth(i)}}var s=e.tableCtrlFixedWidth;if(l.find(".sapUiTableRowHdrScr").length>0){s+=e.tableRowHdrScrWidth}if(r._bRtlMode){t.style.marginRight=s+"px";t.style.marginLeft=""}else{t.style.marginLeft=s+"px";t.style.marginRight=""}var c=r.getDomRef("hsb-content");if(c){c.style.width=i+"px"}}if(!n&&this.isHorizontalScrollbarVisible()){l.removeClass("sapUiTableHScr");t.classList.add("sapUiTableHidden");if(o.browser.safari){l.find(".sapUiTableCtrlScroll, .sapUiTableColHdr").css("width","")}}};w.prototype.updateVerticalScrollbarHeight=function(){var e=this.getTable();var r=this.getVerticalScrollbar();if(!e||!r){return}r.style.maxHeight=this.getVerticalScrollbarHeight()+"px";r._scrollTop=r.scrollTop};w.prototype.getVerticalScrollbarHeight=function(){var e=this.getTable();if(!e){return 0}return e._getRowCounts()._scrollSize*e._getBaseRowHeight()};w.prototype.updateVerticalScrollbarPosition=function(){var e=this.getTable();var r=this.getVerticalScrollbar();if(!e||!r){return}var t=e.getDomRef("tableCCnt");if(t){var o=t.offsetTop;var l=e.getDomRef("vsb-bg");if(l){l.style.top=o+"px"}if(e._getRowCounts().fixedTop>0){o+=e._iVsbTop}r.style.top=o+"px"}};w.prototype.updateVerticalScrollPosition=function(e){var r=this.getTable();if(!r){return}e=e===true;if(e||r.getBinding()){V.performUpdateFromFirstVisibleRow(r,e)}else{V.adjustScrollPositionToFirstVisibleRow(r)}};w.prototype.adjustToTotalRowCount=function(){V.adjustToTotalRowCount(this.getTable())};w.prototype.restoreVerticalScrollPosition=function(){V.restoreScrollPosition(this.getTable())};w.prototype.updateVerticalScrollHeight=function(){var e=this.getVerticalScrollbar();var r=e?e.firstChild:null;if(!r){return}r.style.height=this.getVerticalScrollHeight()+"px";e._scrollTop=e.scrollTop};w.prototype.getVerticalScrollHeight=function(e){var t=this.getTable();if(!t){return 0}var o=t._getTotalRowCount();var l=t._getRowCounts();var i=Math.max(o,l.count);var n=t._getBaseRowHeight();var a;if(r.isVariableRowHeightEnabled(t)){a=n*(i-1)+V.getScrollRangeBuffer(t)}else{a=n*i}if(e===true){return a}else{return Math.min(f,a)}};w.prototype.updateVerticalScrollbarVisibility=function(){var e=this.getTable();var r=e?e.getDomRef():null;var t=this.getVerticalScrollbar();if(!r||!t){return}var o=this.isVerticalScrollbarRequired();if(o&&!this.isVerticalScrollbarVisible()){if(!this.isVerticalScrollbarExternal()){r.classList.add("sapUiTableVScr")}t.classList.remove("sapUiTableHidden")}if(!o&&this.isVerticalScrollbarVisible()){r.classList.remove("sapUiTableVScr");t.classList.add("sapUiTableHidden")}};w.prototype.isVerticalScrollbarRequired=function(){var e=this.getTable();if(!e){return false}return r.isVariableRowHeightEnabled(e)&&V.getScrollRangeOfViewport(e)>0||e._getTotalRowCount()>e._getRowCounts()._fullsize};w.prototype.registerForMouseWheel=function(r,t){var o=this.getTable();if(e.isEnrichedWith(o,"sap.ui.table.extensions.Synchronization")){return m.addMouseWheelEventListener(r,o,t)}else{i.error("This method can only be used with synchronization enabled.",o,"sap.ui.table.extensions.Scrolling#registerForMouseWheel");return null}};w.prototype.registerForTouch=function(r,t){var o=this.getTable();if(e.isEnrichedWith(o,"sap.ui.table.extensions.Synchronization")){return m.addTouchEventListener(r,o,t)}else{i.error("This method can only be used with synchronization enabled.",o,"sap.ui.table.extensions.Scrolling#registerForTouch");return null}};w.prototype._clearCache=function(){var e=this.getTable();if(!e){return}c(e).oVerticalScrollbar=null;c(e).oHorizontalScrollbar=null};w.ScrollDirection=u;return w});